<!DOCTYPE html>
<html lang="ha">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a5f2a">
  <meta name="description" content="MATASA - Rahota Hatsari da Taimako">
  <title>MATASA - Rahota</title>
  
  <!-- Offline support -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1a5f2a">
  
  <!-- Styles optimized for low-end devices -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.4;
      font-size: 16px;
    }
    
    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }
    
    header {
      background: #1a5f2a;
      color: white;
      padding: 16px;
      text-align: center;
    }
    
    header h1 {
      font-size: 1.5rem;
      margin-bottom: 4px;
    }
    
    header p {
      font-size: 0.875rem;
      opacity: 0.9;
    }
    
    .offline-banner {
      display: none;
      background: #ff9800;
      color: white;
      padding: 8px;
      text-align: center;
      font-size: 0.875rem;
    }
    
    .offline-banner.show {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #555;
    }
    
    select, input, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      background: white;
    }
    
    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: #1a5f2a;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .btn-primary {
      background: #1a5f2a;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0d4a1c;
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #e8f5e9;
      color: #1a5f2a;
      margin-top: 8px;
    }
    
    .btn-danger {
      background: #d32f2f;
      color: white;
    }
    
    .type-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .type-btn {
      padding: 12px;
      background: #e8f5e9;
      border: 2px solid transparent;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .type-btn.selected {
      border-color: #1a5f2a;
      background: #c8e6c9;
    }
    
    .type-btn .icon {
      font-size: 1.5rem;
      display: block;
      margin-bottom: 4px;
    }
    
    .type-btn .label {
      font-size: 0.875rem;
      color: #333;
    }
    
    .severity-selector {
      display: flex;
      gap: 8px;
    }
    
    .severity-btn {
      flex: 1;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      text-align: center;
      font-size: 0.875rem;
    }
    
    .severity-btn.selected {
      border-color: #1a5f2a;
      background: #c8e6c9;
    }
    
    .severity-btn[data-value="critical"] { border-color: #d32f2f; }
    .severity-btn[data-value="critical"].selected { background: #ffcdd2; }
    .severity-btn[data-value="high"] { border-color: #f57c00; }
    .severity-btn[data-value="high"].selected { background: #ffe0b2; }
    .severity-btn[data-value="medium"].selected { background: #fff9c4; }
    .severity-btn[data-value="low"].selected { background: #c8e6c9; }
    
    .location-info {
      font-size: 0.875rem;
      color: #666;
      margin-top: 6px;
    }
    
    .location-info.success {
      color: #1a5f2a;
    }
    
    .location-info.error {
      color: #d32f2f;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 6px;
    }
    
    .checkbox-group input {
      width: 20px;
      height: 20px;
    }
    
    .upload-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
    }
    
    .upload-preview {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 8px;
    }
    
    .upload-preview img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 4px;
    }
    
    .preview-item {
      position: relative;
    }
    
    .preview-item .remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 14px;
      cursor: pointer;
    }
    
    .success-message {
      text-align: center;
      padding: 32px 16px;
    }
    
    .success-message .icon {
      font-size: 4rem;
      color: #1a5f2a;
      margin-bottom: 16px;
    }
    
    .success-message h2 {
      color: #1a5f2a;
      margin-bottom: 8px;
    }
    
    .success-message p {
      color: #666;
      margin-bottom: 16px;
    }
    
    .queue-info {
      background: #fff3e0;
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
      font-size: 0.875rem;
    }
    
    .queue-info .count {
      font-weight: 600;
      color: #f57c00;
    }
    
    .hidden {
      display: none !important;
    }
    
    @media (max-width: 360px) {
      .type-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="offline-banner" id="offlineBanner">
    ‚ö†Ô∏è Ba tare da intanet ba - Ana adana rahotonku don aika lokaci
  </div>
  
  <header>
    <h1>MATASA</h1>
    <p>Rahota Hatsari da Taimako</p>
  </header>
  
  <div class="container">
    <!-- Report Type Selection -->
    <div id="step-type" class="card">
      <h2 style="margin-bottom: 16px;">Me kake so ka yi?</h2>
      <div class="type-grid">
        <button class="type-btn" data-type="suspicious_activity">
          <span class="icon">üëÅÔ∏è</span>
          <span class="label">Rahota Abu</span>
        </button>
        <button class="type-btn" data-type="incident_in_progress">
          <span class="icon">üî•</span>
          <span class="label">Harin Yanzu</span>
        </button>
        <button class="type-btn" data-type="medical_emergency">
          <span class="icon">üöë</span>
          <span class="label">Neman Taimako</span>
        </button>
        <button class="type-btn" data-type="other">
          <span class="icon">üìã</span>
          <span class="label">Wani abu</span>
        </button>
      </div>
    </div>
    
    <!-- Severity Selection -->
    <div id="step-severity" class="card hidden">
      <h2 style="margin-bottom: 16px;">Matakara?</h2>
      <div class="severity-selector">
        <button class="severity-btn" data-value="low">∆òasa</button>
        <button class="severity-btn" data-value="medium">Matsakaici</button>
        <button class="severity-btn" data-value="high">Babba</button>
        <button class="severity-btn" data-value="critical">Cyrori</button>
      </div>
    </div>
    
    <!-- Location -->
    <div id="step-location" class="card hidden">
      <h2 style="margin-bottom: 16px;">Wuri?</h2>
      <button class="btn-primary" id="getLocation">
        üìç Sami Wuri ta Atomatik
      </button>
      <p class="location-info" id="locationInfo">Zaka iya za…ìi wuri da hannu idan ba zai yi ba</p>
      
      <div style="margin-top: 16px;">
        <label>Ko za…ìi wurin kanka:</label>
        <select id="stateSelect">
          <option value="">Za…ìi Jiha</option>
          <option value="Kano">Kano</option>
          <option value="Katsina">Katsina</option>
          <option value="Kaduna">Kaduna</option>
          <option value=" Bauchi">Bauchi</option>
          <option value="Other">Wani</option>
        </select>
      </div>
    </div>
    
    <!-- Description -->
    <div id="step-description" class="card hidden">
      <h2 style="margin-bottom: 16px;">Bayani</h2>
      <textarea id="description" placeholder="Rubuta bayanin abin da kaga ko abin da faru..."></textarea>
      
      <!-- Photo Upload -->
      <div style="margin-top: 16px;">
        <label>Hotuna (za…ìi):</label>
        <input type="file" id="photoInput" accept="image/*" capture="environment" multiple hidden>
        <button class="upload-btn" onclick="document.getElementById('photoInput').click()">
          üì∑ ∆òara Hoto
        </button>
        <div class="upload-preview" id="photoPreview"></div>
      </div>
      
      <!-- Audio Upload -->
      <div style="margin-top: 16px;">
        <label>Muryoyi (za…ìi):</label>
        <input type="file" id="audioInput" accept="audio/*" capture hidden>
        <button class="upload-btn" onclick="startAudioRecording()">
          üé§ ∆òara Murya
        </button>
        <div id="audioPreview"></div>
      </div>
    </div>
    
    <!-- Callback Consent -->
    <div id="step-consent" class="card hidden">
      <h2 style="margin-bottom: 16px;">Tuntuba</h2>
      <div class="checkbox-group">
        <input type="checkbox" id="callbackConsent">
        <label for="callbackConsent">Ina so su Kira ni idan kuna bu∆ôatar ∆ôarin bayani</label>
      </div>
      
      <input type="tel" id="phoneNumber" placeholder="Lambar tarho (+234...)" style="margin-top: 16px;">
    </div>
    
    <!-- Submit -->
    <div id="step-submit" class="card hidden">
      <button class="btn-primary" id="submitBtn">Aika Rahoto</button>
      <button class="btn-secondary" id="backBtn">Koma Baya</button>
    </div>
    
    <!-- Success -->
    <div id="step-success" class="card hidden">
      <div class="success-message">
        <div class="icon">‚úÖ</div>
        <h2>An Kar…ìi Rahotonku!</h2>
        <p>ID: <span id="incidentId"></span></p>
        <p id="statusMessage">Za mu yi amfani da shi don taimakawa al'umma.</p>
      </div>
      <div class="queue-info" id="queueInfo" style="display: none;">
        <strong>üì§ Rahotanni da aka adana:</strong>
        <span class="count" id="queueCount">0</span> ana jiran aika
      </div>
      <button class="btn-primary" style="margin-top: 16px;" onclick="resetForm()">
        Rahota Wani
      </button>
    </div>
  </div>
  
  <script>
    // Service Worker for offline support
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(err => {
        console.log('SW registration failed:', err);
      });
    }
    
    // State
    let formData = {
      incidentType: '',
      severity: '',
      latitude: null,
      longitude: null,
      accuracy: null,
      state: '',
      description: '',
      photos: [],
      audio: null,
      callbackConsent: false,
      phoneNumber: '',
    };
    
    // Current step
    let currentStep = 'type';
    
    // Offline queue
    let offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
    
    // DOM elements
    const steps = {
      type: document.getElementById('step-type'),
      severity: document.getElementById('step-severity'),
      location: document.getElementById('step-location'),
      description: document.getElementById('step-description'),
      consent: document.getElementById('step-consent'),
      submit: document.getElementById('step-submit'),
      success: document.getElementById('step-success'),
    };
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      updateOfflineBanner();
      updateQueueCount();
      setupEventListeners();
    });
    
    function setupEventListeners() {
      // Type selection
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          formData.incidentType = btn.dataset.type;
          showStep('severity');
        });
      });
      
      // Severity selection
      document.querySelectorAll('.severity-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          formData.severity = btn.dataset.value;
          showStep('location');
        });
      });
      
      // Location
      document.getElementById('getLocation').addEventListener('click', getLocation);
      document.getElementById('stateSelect').addEventListener('change', (e) => {
        formData.state = e.target.value;
      });
      
      // Photo upload
      document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
      
      // Consent
      document.getElementById('callbackConsent').addEventListener('change', (e) => {
        formData.callbackConsent = e.target.checked;
        document.getElementById('phoneNumber').style.display = e.target.checked ? 'block' : 'none';
      });
      document.getElementById('phoneNumber').addEventListener('input', (e) => {
        formData.phoneNumber = e.target.value;
      });
      
      // Submit
      document.getElementById('submitBtn').addEventListener('click', submitForm);
      document.getElementById('backBtn').addEventListener('click', goBack);
    }
    
    function showStep(step) {
      // Hide all steps
      Object.values(steps).forEach(el => el.classList.add('hidden'));
      // Show current step
      steps[step].classList.remove('hidden');
      currentStep = step;
    }
    
    function goBack() {
      const stepOrder = ['type', 'severity', 'location', 'description', 'consent', 'submit'];
      const currentIndex = stepOrder.indexOf(currentStep);
      if (currentIndex > 0) {
        showStep(stepOrder[currentIndex - 1]);
      }
    }
    
    function getLocation() {
      const info = document.getElementById('locationInfo');
      info.textContent = 'Ana neman wuri...';
      info.className = 'location-info';
      
      if (!navigator.geolocation) {
        info.textContent = 'Ba za a iya samu da atomatik ba. Za…ìi wurin kanka.';
        info.className = 'location-info error';
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          formData.latitude = position.coords.latitude;
          formData.longitude = position.coords.longitude;
          formData.accuracy = position.coords.accuracy;
          
          info.textContent = `Wuri an samo: ${Math.round(position.coords.accuracy)}m daidaito`;
          info.className = 'location-info success';
        },
        (error) => {
          info.textContent = 'Ba za a iya samu da atomatik ba. Za…ìi wurin kanka.';
          info.className = 'location-info error';
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }
    
    function handlePhotoUpload(e) {
      const files = Array.from(e.target.files);
      const preview = document.getElementById('photoPreview');
      
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          formData.photos.push(e.target.result);
          const div = document.createElement('div');
          div.className = 'preview-item';
          div.innerHTML = `
            <img src="${e.target.result}">
            <button class="remove" onclick="removePhoto(${formData.photos.length - 1})">√ó</button>
          `;
          preview.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
    }
    
    function removePhoto(index) {
      formData.photos.splice(index, 1);
      renderPhotoPreview();
    }
    
    function renderPhotoPreview() {
      const preview = document.getElementById('photoPreview');
      preview.innerHTML = formData.photos.map((photo, i) => `
        <div class="preview-item">
          <img src="${photo}">
          <button class="remove" onclick="removePhoto(${i})">√ó</button>
        </div>
      `).join('');
    }
    
    let mediaRecorder;
    let audioChunks = [];
    
    async function startAudioRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (e) => {
          audioChunks.push(e.data);
        };
        
        mediaRecorder.onstop = () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          const reader = new FileReader();
          reader.onload = () => {
            formData.audio = reader.result;
            document.getElementById('audioPreview').innerHTML = `
              <audio controls src="${reader.result}" style="width: 100%; margin-top: 8px;"></audio>
            `;
          };
          reader.readAsDataURL(blob);
        };
        
        mediaRecorder.start();
        
        // Record for up to 30 seconds
        setTimeout(() => {
          if (mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
          }
        }, 30000);
        
        alert('Ana mu…óa... yi magana sai ka danna OK');
      } catch (err) {
        console.error('Audio recording failed:', err);
        alert('Ba za a iya …óaukar murya ba');
      }
    }
    
    async function submitForm() {
      formData.description = document.getElementById('description').value;
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Ana aika...';
      
      const report = {
        id: Date.now().toString(36),
        timestamp: Date.now(),
        ...formData,
      };
      
      if (navigator.onLine) {
        try {
          const response = await fetch('/api/v1/incidents', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              channel: 'mobile',
              incidentType: formData.incidentType,
              severity: formData.severity,
              latitude: formData.latitude,
              longitude: formData.longitude,
              accuracy: formData.accuracy,
              state: formData.state,
              description: formData.description,
              photoUrls: formData.photos,
              audioUrl: formData.audio,
              callbackConsent: formData.callbackConsent,
              phoneNumber: formData.phoneNumber,
            }),
          });
          
          if (!response.ok) throw new Error('Submission failed');
          
          const data = await response.json();
          document.getElementById('incidentId').textContent = data.incidentId;
          showStep('success');
        } catch (err) {
          console.error('Submission error:', err);
          // Queue for later
          queueReport(report);
        }
      } else {
        queueReport(report);
        document.getElementById('incidentId').textContent = report.id;
        document.getElementById('statusMessage').textContent = 'An adana rahotonku. Za aika lokacin da ka sami intanet.';
        showStep('success');
      }
      
      submitBtn.disabled = false;
      submitBtn.textContent = 'Aika Rahoto';
    }
    
    function queueReport(report) {
      offlineQueue.push(report);
      localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
      updateQueueCount();
    }
    
    function updateQueueCount() {
      const count = document.getElementById('queueCount');
      const info = document.getElementById('queueInfo');
      if (offlineQueue.length > 0) {
        count.textContent = offlineQueue.length;
        info.style.display = 'block';
      } else {
        info.style.display = 'none';
      }
    }
    
    // Try to sync when online
    window.addEventListener('online', () => {
      updateOfflineBanner();
      syncQueue();
    });
    
    window.addEventListener('offline', () => {
      updateOfflineBanner();
    });
    
    function updateOfflineBanner() {
      const banner = document.getElementById('offlineBanner');
      banner.classList.toggle('show', !navigator.onLine);
    }
    
    async function syncQueue() {
      if (offlineQueue.length === 0) return;
      
      const queue = [...offlineQueue];
      offlineQueue = [];
      localStorage.setItem('offlineQueue', '[]');
      
      for (const report of queue) {
        try {
          await fetch('/api/v1/incidents', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              channel: 'mobile',
              incidentType: report.incidentType,
              severity: report.severity,
              latitude: report.latitude,
              longitude: report.longitude,
              state: report.state,
              description: report.description,
              callbackConsent: report.callbackConsent,
              phoneNumber: report.phoneNumber,
            }),
          });
        } catch (err) {
          // Requeue failed reports
          offlineQueue.push(report);
          localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
        }
      }
      
      updateQueueCount();
    }
    
    function resetForm() {
      formData = {
        incidentType: '',
        severity: '',
        latitude: null,
        longitude: null,
        accuracy: null,
        state: '',
        description: '',
        photos: [],
        audio: null,
        callbackConsent: false,
        phoneNumber: '',
      };
      
      document.getElementById('description').value = '';
      document.getElementById('callbackConsent').checked = false;
      document.getElementById('phoneNumber').value = '';
      document.getElementById('phoneNumber').style.display = 'none';
      document.getElementById('photoPreview').innerHTML = '';
      document.getElementById('audioPreview').innerHTML = '';
      document.getElementById('locationInfo').textContent = 'Zaka iya za…ìi wuri da hannu idan ba zai yi ba';
      document.getElementById('locationInfo').className = 'location-info';
      
      showStep('type');
    }
  </script>
</body>
</html>
